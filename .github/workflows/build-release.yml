name: On push of a tag
on:
  push:
    tags:
    - v*

env:
  REGISTRY_USER: rh-ee-chbutler
  IMAGE_REGISTRY: quay.io
  IMAGE: rhel-dev

jobs:
  build:
    name: Build ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    container:
      image: registry.access.redhat.com/ubi9/ubi@sha256:b8923f58ef6aebe2b8f543f8f6c5af15c6f9aeeef34ba332f33bf7610012de0c  # ubi9
      options: --privileged
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
    - name: Prepare platform pair
      run: |
        platform=${{ matrix.platform }}
        echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

    - name: Get container tools in UBI builder
      run: dnf -y install podman buildah skopeo make wget git jq

    - name: Checkout repository
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Access a subscription via activation key
      env:
        SMDEV_CONTAINER_OFF: 1
        orgid: ${{ secrets.RHT_ORGID }}
        activation_key: ${{ secrets.RHT_ACT_KEY }}
      run: subscription-manager register --org=$orgid --activationkey=$activation_key

    - name: Workaround open podman-login action issue
      env:
        auth: "{ \"auths\": {} }"
      run: |
        mkdir -p $HOME/.docker
        echo $auth > $HOME/.docker/config.json

    - name: Parse version
      id: parse_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Log in to Quay.io
      uses: redhat-actions/podman-login@4934294ad0449894bcd1e9f191899d7292469603 # v1
      with:
        username: ${{ secrets.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
        registry: ${{ env.IMAGE_REGISTRY }}
        auth_file_path: /run/containers/0/auth.json

    - name: Log in to registry.redhat.io
      uses: redhat-actions/podman-login@4934294ad0449894bcd1e9f191899d7292469603 # v1
      with:
        username: ${{ secrets.RH_REGISTRY_USER }}
        password: ${{ secrets.RH_REGISTRY_PASSWORD }}
        registry: registry.redhat.io
        auth_file_path: /run/containers/0/auth.json

    - name: Pull deps
      run: make get-deps

    - name: Build Image
      id: build-image
      uses: redhat-actions/buildah-build@7a95fa7ee0f02d552a32753e7414641a04307056 # v2
      with:
        image: ${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}
        tags: ${{ env.PLATFORM_PAIR }}-${{ github.sha }}
        containerfiles: |
          ./Containerfile

    - name: Push image by digest
      id: push
      run: |
        buildah push --digestfile /tmp/digest \
          ${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}:${{ env.PLATFORM_PAIR }}-${{ github.sha }} \
          docker://${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}:${{ env.PLATFORM_PAIR }}-${{ github.sha }}
        echo "digest=$(cat /tmp/digest)" >> $GITHUB_OUTPUT

    - name: Export digest
      run: |
        mkdir -p /tmp/digests
        digest="${{ steps.push.outputs.digest }}"
        touch "/tmp/digests/${digest#sha256:}"

    - name: Upload digest
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      with:
        name: digests-${{ env.PLATFORM_PAIR }}
        path: /tmp/digests/*
        if-no-files-found: error
        retention-days: 1

    - name: Clean up the subscription
      if: always()
      env:
        SMDEV_CONTAINER_OFF: 1
      run: subscription-manager unregister

  merge:
    name: Create multi-arch manifest and sign
    outputs:
      digest: ${{ steps.manifest_digest.outputs.digest }}
      version: ${{ steps.parse_version.outputs.VERSION }}
    runs-on: ubuntu-latest
    needs: build
    container:
      image: registry.access.redhat.com/ubi9/ubi@sha256:b8923f58ef6aebe2b8f543f8f6c5af15c6f9aeeef34ba332f33bf7610012de0c  # ubi9
      options: --privileged
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
    - name: Get container tools
      run: dnf -y install podman buildah skopeo jq

    - name: Download digests
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
      with:
        path: /tmp/digests
        pattern: digests-*
        merge-multiple: true

    - name: Workaround open podman-login action issue
      env:
        auth: "{ \"auths\": {} }"
      run: |
        mkdir -p $HOME/.docker
        echo $auth > $HOME/.docker/config.json

    - name: Parse version
      id: parse_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Log in to Quay.io
      uses: redhat-actions/podman-login@4934294ad0449894bcd1e9f191899d7292469603 # v1
      with:
        username: ${{ secrets.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
        registry: ${{ env.IMAGE_REGISTRY }}
        auth_file_path: /run/containers/0/auth.json

    - name: Create and push manifest
      run: |
        IMAGE_URI="${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}"
        VERSION="${{ steps.parse_version.outputs.VERSION }}"

        # Create manifest list for each tag
        for TAG in latest prod $VERSION ${{ github.sha }}; do
          buildah manifest create ${IMAGE_URI}:${TAG}

          # Add each architecture
          for digest in /tmp/digests/*; do
            digest_hash=$(basename $digest)
            buildah manifest add ${IMAGE_URI}:${TAG} docker://${IMAGE_URI}@sha256:${digest_hash}
          done

          # Push the manifest
          buildah manifest push --all ${IMAGE_URI}:${TAG} docker://${IMAGE_URI}:${TAG}
        done

    - name: Inspect manifest
      run: |
        IMAGE_URI="${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}"
        buildah manifest inspect ${IMAGE_URI}:prod

    - name: Install Cosign
      uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

    - name: Sign image recursively
      run: |
        IMAGE_URI="${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}"
        VERSION="${{ steps.parse_version.outputs.VERSION }}"

        cosign sign --yes --recursive \
          -a tag=$VERSION \
          -a tag=prod \
          -a tag=latest \
          -a tag=${{ github.sha }} \
          -a sha=${{ github.sha }} \
          -a run_id=${{ github.run_id }} \
          -a run_attempt="$GITHUB_RUN_ATTEMPT" \
          ${IMAGE_URI}:prod

    - name: Get manifest digest
      id: manifest_digest
      run: |
        IMAGE_URI="${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}"
        DIGEST=$(skopeo inspect --format '{{.Digest}}' docker://${IMAGE_URI}:prod)
        echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

  attest:
    name: Attest, scan, and generate SBOM
    runs-on: ubuntu-latest
    needs: merge
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
      security-events: write

    steps:
    - name: Harden runner
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit

    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Log in to Quay.io
      uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
      with:
        registry: ${{ env.IMAGE_REGISTRY }}
        username: ${{ secrets.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - name: Generate SBOM
      uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2
      with:
        image: ${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}@${{ needs.merge.outputs.digest }}
        format: spdx-json
        output-file: sbom.spdx.json

    - name: Attest build provenance
      uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2.4.0
      with:
        subject-name: ${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}
        subject-digest: ${{ needs.merge.outputs.digest }}
        push-to-registry: true

    - name: Attest SBOM
      uses: actions/attest-sbom@bd218ad0dbcb3e146bd073d1d9c6d78e08aa8a0b # v2.4.0
      with:
        subject-name: ${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}
        subject-digest: ${{ needs.merge.outputs.digest }}
        sbom-path: sbom.spdx.json
        push-to-registry: true

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # v0.34.0
      with:
        image-ref: ${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}/${{ env.IMAGE }}@${{ needs.merge.outputs.digest }}
        format: sarif
        output: trivy-results.sarif
        severity: CRITICAL,HIGH

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@f5c2471be782132e47a6e6f9c725e56730d6e9a3 # v3.32.3
      with:
        sarif_file: trivy-results.sarif
